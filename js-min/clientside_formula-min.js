var cell_errors={};function evaluate_cell(a){this_=$("#CELL_"+a);try{_new_value=formula_single_cell_value(a);this_.removeClass("cell_error");cell_errors[a]="";if(this_[0].nodeName=="INPUT"){$(this_).attr("value",_new_value)}else{$(this_).html(_new_value)}}catch(c){this_.addClass("cell_error");cell_errors[a]=c;var b=$("#CELL_"+a).attr("title");if(this_[0].nodeName=="INPUT"){$(this_).attr("value","Err")}else{$(this_).html(b)}}}function is_array(a){return a.constructor.toString().indexOf("Array")!=-1}function formula_eval(_formula){if(_formula.match(/^=/)){if(!_formula.match(/^=["A-Za-z0-9\.\(\)\*/:+-]+$/)){throw ("Formula has unsafe characters")}if(_formula.match(/(\/\*|\/\/)/)){throw ("Formula has unsafe characters // or /*")}var strings=(_formula.replace(/".*?"/g,"")+" ").match(/[a-z]{3,}/gi);if(strings){for(var i=0;i<strings.length;i++){if(!strings[i].match(/^(SUM|MAX|MIN|AVG)$/)){throw ('Formula has unknown string: "'+strings[i]+'"')}}}_eval_formula=_formula.replace(/\b([A-Z]{1,2}[0-9]{1,3})\b/g,"formula_single_cell_value('$1')");_eval_formula=_eval_formula.replace(/\bformula_single_cell_value\(\'([A-Z]{1,2}[0-9]{1,3})\'\):formula_single_cell_value\(\'([A-Z]{1,2}[0-9]{1,3})\'\)/g,"formula_range_value('$1', '$2')");_eval_formula=_eval_formula.replace(/\bSUM\(/g,"formula_sum(");_eval_formula=_eval_formula.replace(/\bAVG\(/g,"formula_avg(");_eval_formula=_eval_formula.replace(/\bMAX\(/g,"formula_max(");_eval_formula=_eval_formula.replace(/\bMIN\(/g,"formula_min(");_eval_formula=_eval_formula.replace(/^=/,"");var _new_value="";try{_new_value=eval(_eval_formula);if(is_array(_new_value)){_new_value=_new_value.join(",")}}catch(err){throw ("Can not evaluate formula.")}return _new_value}else{return _formula}}function formula_sum(a){if(!is_array(a)){return parseFloat(a)}var b=0;for(var c=0;c<a.length;c++){if(parseFloat(a[c])){b+=parseFloat(a[c])}}return b}function formula_avg(a){var d=0;if(!is_array(a)){return parseFloat(a)}var b=0;for(var c=0;c<a.length;c++){if(parseFloat(a[c])){b+=parseFloat(a[c]);d++}}return Math.round((b/d)*100)/100}function formula_max(a){var b=null;for(var c=0;c<a.length;c++){if(parseFloat(a[c])){if((parseFloat(a[c])>b)||(b==null)){b=parseFloat(a[c])}}}return Math.round(b*100)/100}function formula_min(a){var b=null;for(var c=0;c<a.length;c++){if(parseFloat(a[c])){if((parseFloat(a[c])<b)||(b==null)){b=parseFloat(a[c])}}}return Math.round(b*100)/100}function formula_range_value(k,g){var d=k.match(/^([A-Z]+)/)[0].charCodeAt(0);var c=g.match(/^([A-Z]+)/)[0].charCodeAt(0);var h=[];var f=parseInt(k.match(/([0-9]+)$/)[0]);var e=parseInt(g.match(/([0-9]+)$/)[0]);for(var b=d;(b<=c)&&(b<=90);b++){for(var a=f;a<=e;a++){h.push(formula_single_cell_value(String.fromCharCode(b)+a))}}return h}hits=0;calcs=0;function formula_single_cell_value(a){calcs++;if(cells_cache[a]=="calculating_34#43"){throw ("Cyclic reference (A depends on B, while B depends on A)")}if(cells_cache[a]){hits++;window.status="Stats: Cache hits: "+hits+"; total calcs: "+calcs;return cells_cache[a]}if(!a.match(/^[A-Z]{1,2}[0-9]+$/)){cells_cache[a]="";return""}var b=$("#CELL_"+a).attr("title");if(b==null){return""}if(b.match(/^([0-9]+\.[0-9]*|[0-9]*\.[0-9]+)$/)){return parseFloat(b)}if(b.match(/^([0-9]+)$/)){return parseInt(b)}cells_cache[a]="calculating_34#43";cells_cache[a]=formula_eval(b);return cells_cache[a]}var cells_cache={};function evaluate_cells(){cells_cache={};$("td.cell").each(function(){evaluate_cell(this.id.replace(/^CELL_/,""))})}function evaluate_cells(a){cells_cache={};$(a+".cell").each(function(){evaluate_cell(this.id.replace(/^CELL_/,""))})}function build_cache(c){var b,a;cells_cache={};$(c+".cell").add(c+".numInput").each(function(){a=this.id.replace(/^CELL_/,"");b=formula_single_cell_value(a);cells_cache[a]=b;return})}function set_cell_value(a,c){var b=$("#CELL_"+a);if(b!=undefined&&typeof(b.attr("title"))=="string"){if(!b.attr("title").match(/^=/)){b.attr("value",c).attr("title",c)}}};